<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ù†ØµØ© Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¹Ù„ÙˆÙ… - Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…Ø© Ø¨Ø¯Ø±ÙŠØ© Ù…Ø­Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border:#d1d5db;
      --green:#0f7a3a;      /* Ø£Ø®Ø¶Ø± Ø±Ø³Ù…ÙŠ */
      --green2:#16a34a;     /* Ø£Ø®Ø¶Ø± Ø²Ø± */
      --soft:#f8fafc;
      --shadow: 0 10px 24px rgba(15, 23, 42, .08);
      --radius:14px;
      --max: 860px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      font-size:18px;
      line-height:1.6;
    }
    .page{
      max-width: var(--max);
      margin: 0 auto;
      padding: 20px 14px 40px;
    }
    .header{
      border:1px solid var(--border);
      border-top: 6px solid var(--green);
      border-radius: var(--radius);
      background: #fff;
      box-shadow: var(--shadow);
      padding: 16px 16px;
      text-align:center;
    }
    .header h1{margin:0; font-size:22px}
    .header .sub{margin:6px 0 0; color:var(--muted); font-size:14px}

    .nav{
      margin-top: 12px;
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .btn{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      padding:10px 14px;
      border-radius: 12px;
      cursor:pointer;
      font-size:15px;
      box-shadow: 0 4px 10px rgba(15, 23, 42, .05);
    }
    .btn:hover{background:var(--soft)}
    .btn.primary{
      border-color: rgba(15,122,58,.35);
      background: rgba(15,122,58,.08);
    }
    .btn.green{
      border-color: rgba(22,163,74,.35);
      background: rgba(22,163,74,.10);
    }
    .btn.danger{
      border-color: rgba(220,38,38,.35);
      background: rgba(220,38,38,.06);
      color:#7f1d1d;
    }

    .card{
      margin-top: 14px;
      border:1px solid var(--border);
      border-left: 6px solid var(--green);
      border-radius: var(--radius);
      background:#fff;
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .card h2{margin:0 0 10px; font-size:18px}
    .muted{color:var(--muted); font-size:14px}

    label{display:block; margin-top:10px; color:var(--muted); font-size:14px}
    input, select, textarea{
      width:100%;
      margin-top:6px;
      padding:12px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background:#fff;
      font-size:16px;
      outline:none;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(15,122,58,.55);
      box-shadow: 0 0 0 4px rgba(15,122,58,.10);
    }
    textarea{min-height:90px; resize:vertical}

    .row{display:flex; gap:10px; flex-wrap:wrap}
    .col{flex:1; min-width:240px}

    .notice{
      margin-top: 10px;
      background: #f0fdf4;
      border:1px dashed rgba(22,163,74,.45);
      color:#14532d;
      border-radius: 12px;
      padding:10px 12px;
      font-size:14px;
    }

    /* Rubric */
    .rubric{display:grid; gap:10px; margin-top:12px}
    .crit{
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: #fff;
    }
    .critHead{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      align-items:center;
    }
    .critName{font-weight:700}
    .levels{
      margin-top:10px;
      display:grid;
      gap:10px;
    }
    @media(min-width:760px){ .levels{grid-template-columns: repeat(4, 1fr)} }
    .lvl{
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background:#fff;
      cursor:pointer;
      user-select:none;
      min-height:78px;
      display:flex; flex-direction:column; gap:6px;
    }
    .lvl b{font-size:14px}
    .lvl span{font-size:12px; color:var(--muted)}
    .lvl.active{
      border-color: rgba(22,163,74,.70);
      background: rgba(22,163,74,.08);
      box-shadow: 0 0 0 4px rgba(22,163,74,.10);
    }

    /* Table list */
    .tools{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px;
    }
    .search{
      flex:1; min-width:220px;
    }
    .list{
      margin-top: 12px;
      display:grid; gap:10px;
    }
    .item{
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background:#fff;
    }
    .itemTop{
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:10px; flex-wrap:wrap;
    }
    .itemTitle{font-weight:800}
    .itemMeta{color:var(--muted); font-size:13px; margin-top:4px}
    .itemBtns{display:flex; gap:8px; flex-wrap:wrap}
    .pill{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(15,122,58,.25);
      background: rgba(15,122,58,.06);
      color:#14532d;
      margin-inline-start:6px;
    }
    .hr{height:1px; background:var(--border); margin:12px 0}

    @media print{
      .nav, .itemBtns, .tools {display:none !important}
      body{background:#fff}
      .card, .header{box-shadow:none}
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="header">
      <h1>Ù…Ù†ØµØ© Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¹Ù„ÙˆÙ…</h1>
      <div class="sub">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…Ø© Ø¨Ø¯Ø±ÙŠØ© Ù…Ø­Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</div>

      <div class="nav">
        <button class="btn primary" id="goForm">ğŸ“ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
        <button class="btn" id="goList">ğŸ“š Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</button>
        <button class="btn danger" id="clearLocal" title="ÙŠÙ…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙ‚Ø·">ğŸ§¹ Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²</button>
      </div>
    </div>

    <div id="view"></div>
  </div>

<script>
  // ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© =====
  const LS_GRADE = "science_obs_grade_v1";
  const LS_OBS   = "science_observations_v2";

  // Ø³Ù„Ø§Ù„Ù… Ø§Ù„ØªÙ‚Ø¯ÙŠØ± (4 Ù…Ø³ØªÙˆÙŠØ§Øª) - ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ
  const RUBRIC = [
    { key:"objective", name:"ÙˆØ¶ÙˆØ­ Ø§Ù„Ù‡Ø¯Ù", desc:["ØºÙŠØ± ÙˆØ§Ø¶Ø­", "ÙˆØ§Ø¶Ø­ Ø¬Ø²Ø¦ÙŠÙ‹Ø§", "ÙˆØ§Ø¶Ø­", "ÙˆØ§Ø¶Ø­ ÙˆÙ…ÙØ¹Ù„Ù†"] },
    { key:"engage",    name:"ØªÙØ§Ø¹Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª", desc:["Ø¶Ø¹ÙŠÙ", "Ù…ØªÙˆØ³Ø·", "Ø¬ÙŠØ¯", "Ø¹Ø§Ù„Ù ÙˆÙ…ØªÙ†ÙˆØ¹"] },
    { key:"strategy",  name:"Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ³", desc:["ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨Ø©", "Ù…Ø­Ø¯ÙˆØ¯Ø©", "Ù…Ù†Ø§Ø³Ø¨Ø©", "Ù…Ù†Ø§Ø³Ø¨Ø© + ØªÙ…Ø§ÙŠØ²"] },
    { key:"assessment",name:"Ø§Ù„ØªÙ‚ÙˆÙŠÙ… ÙˆØ§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø©", desc:["Ù„Ø§ ÙŠÙˆØ¬Ø¯", "Ù…Ø­Ø¯ÙˆØ¯", "Ù…Ø³ØªÙ…Ø±", "Ù…Ø³ØªÙ…Ø± + ÙØ§Ø¹Ù„"] },
    { key:"classroom", name:"Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ", desc:["ØªØ­ØªØ§Ø¬ Ø¯Ø¹Ù…", "Ù…Ù‚Ø¨ÙˆÙ„Ø©", "Ø¬ÙŠØ¯Ø©", "Ù…ØªÙ…ÙŠØ²Ø©"] },
  ];

  function esc(s){ return (s??"").toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function nowISO(){ return new Date().toISOString(); }
  function uid(){ return (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2)); }

  function loadObs(){ return JSON.parse(localStorage.getItem(LS_OBS) || "[]"); }
  function saveObs(list){ localStorage.setItem(LS_OBS, JSON.stringify(list)); }

  function getToday(){
    const t = new Date();
    const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), d=String(t.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }

  // ===== ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ =====
  const view = document.getElementById("view");

  function renderForm(editId=null){
    const gradeSaved = localStorage.getItem(LS_GRADE) || "";
    const list = loadObs();
    const existing = editId ? list.find(x=>x.id===editId) : null;

    const v = existing || {
      id: uid(),
      createdAt: nowISO(),
      updatedAt: nowISO(),
      grade: gradeSaved,
      date: getToday(),
      lessonTitle: "",
      observerName: "Ø¨Ø¯Ø±ÙŠØ© Ù…Ø­Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ",
      teacherObserved: "",
      notes: "",
      levels: {}
    };

    // Ø¨Ù†Ø§Ø¡ rubric HTML
    const rubricHtml = RUBRIC.map((c, idx)=>{
      const picked = v.levels?.[c.key] || 0;
      const levelBoxes = [1,2,3,4].map(lvl=>`
        <div class="lvl ${picked===lvl ? "active" : ""}" data-crit="${esc(c.key)}" data-lvl="${lvl}">
          <b>Ù…Ø³ØªÙˆÙ‰ ${lvl}</b>
          <span>${esc(c.desc[lvl-1])}</span>
        </div>
      `).join("");

      return `
        <div class="crit">
          <div class="critHead">
            <div class="critName">${idx+1}) ${esc(c.name)}</div>
            <div class="muted">Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø³ØªÙˆÙ‰ ÙˆØ§Ø­Ø¯</div>
          </div>
          <div class="levels">${levelBoxes}</div>
        </div>
      `;
    }).join("");

    view.innerHTML = `
      <div class="card">
        <h2>ğŸ“ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ${editId ? '<span class="pill">ØªØ¹Ø¯ÙŠÙ„</span>' : ""}</h2>
        <div class="notice">
          ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø². ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù‡Ø§ ÙˆØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª Ù…Ù† "Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª".
        </div>

        <div class="row">
          <div class="col">
            <label>Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
            <select id="grade">
              <option value="">-- Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ØµÙ --</option>
              <option value="4">Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹</option>
              <option value="5">Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</option>
              <option value="6">Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option>
            </select>
          </div>
          <div class="col">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</label>
            <input id="date" type="date" value="${esc(v.date)}" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³</label>
            <input id="lessonTitle" placeholder="Ù…Ø«Ø§Ù„: Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø§Ø¯Ø©" value="${esc(v.lessonTitle)}" />
          </div>
          <div class="col">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ø§Ø­ÙØ¸Ø©</label>
            <input id="observerName" value="${esc(v.observerName)}" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø© Ø§Ù„Ù…ÙÙ„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="teacherObserved" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" value="${esc(v.teacherObserved)}" />
          </div>
          <div class="col">
            <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label>
            <input value="${editId ? "ØªØ­Ø¯ÙŠØ« Ø¨Ø·Ø§Ù‚Ø© Ù…Ø­ÙÙˆØ¸Ø©" : "Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø·Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©"}" disabled />
          </div>
        </div>

        <div class="hr"></div>

        <h2 style="font-size:16px;margin:0 0 6px">Ø³Ù„Ø§Ù„Ù… Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</h2>
        <div class="rubric" id="rubricBox">${rubricHtml}</div>

        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù†ÙˆØ¹ÙŠØ©</label>
        <textarea id="notes" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª...">${esc(v.notes)}</textarea>

        <div class="tools">
          <button class="btn green" id="saveBtn">ğŸ’¾ ${editId ? "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©" : "Ø­ÙØ¸ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©"}</button>
          <button class="btn" id="newBtn">â• Ø¨Ø·Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
          <button class="btn" id="printBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn" id="listBtn">ğŸ“š Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</button>
        </div>

        <div class="muted" style="margin-top:10px">
          * Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø³Ù… Ø·Ø§Ù„Ø¨Ø© Ù‡Ù†Ø§ Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ. Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¨Ø¯Ø£ Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ Ø«Ù… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©.
        </div>
      </div>
    `;

    // Ø¶Ø¨Ø· Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ
    const gradeSel = document.getElementById("grade");
    gradeSel.value = v.grade || "";
    gradeSel.onchange = () => localStorage.setItem(LS_GRADE, gradeSel.value);

    // ØªÙØ¹ÙŠÙ„ rubric Ø§Ø®ØªÙŠØ§Ø±
    const levels = {...(v.levels || {})};
    document.querySelectorAll(".lvl").forEach(box=>{
      box.addEventListener("click", ()=>{
        const crit = box.getAttribute("data-crit");
        const lvl  = Number(box.getAttribute("data-lvl"));
        levels[crit] = lvl;

        // Ø¥Ø·ÙØ§Ø¡ Ø¨Ø§Ù‚ÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¹ÙŠØ§Ø±
        document.querySelectorAll(`.lvl[data-crit="${crit}"]`).forEach(x=>x.classList.remove("active"));
        box.classList.add("active");
      });
    });

    // Ø­ÙØ¸/ØªØ­Ø¯ÙŠØ«
    document.getElementById("saveBtn").onclick = () => {
      const grade = gradeSel.value;
      const date  = (document.getElementById("date").value || "").trim();
      const lessonTitle = (document.getElementById("lessonTitle").value || "").trim();
      const observerName = (document.getElementById("observerName").value || "").trim();
      const teacherObserved = (document.getElementById("teacherObserved").value || "").trim();
      const notes = (document.getElementById("notes").value || "").trim();

      const pickedCount = Object.keys(levels).length;

      if(!grade){ alert("ÙØ¶Ù„Ø§Ù‹ Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ."); return; }
      if(!lessonTitle){ alert("ÙØ¶Ù„Ø§Ù‹ Ø§ÙƒØªØ¨ÙŠ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³."); return; }
      if(pickedCount < 3){ alert("ÙØ¶Ù„Ø§Ù‹ Ø§Ø®ØªØ§Ø±ÙŠ Ø³Ù„Ø§Ù„Ù… Ø§Ù„ØªÙ‚Ø¯ÙŠØ± (Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 3 Ù…Ø¹Ø§ÙŠÙŠØ±)."); return; }

      const list = loadObs();
      const record = {
        id: v.id,
        createdAt: v.createdAt || nowISO(),
        updatedAt: nowISO(),
        grade, date, lessonTitle, observerName, teacherObserved, notes,
        levels
      };

      const idx = list.findIndex(x=>x.id===record.id);
      if(idx >= 0) list[idx] = record;
      else list.unshift(record);

      saveObs(list);
      alert(idx>=0 ? "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© âœ…" : "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© âœ…");
      renderList(); // Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    };

    document.getElementById("newBtn").onclick = ()=> renderForm(null);
    document.getElementById("printBtn").onclick = ()=> window.print();
    document.getElementById("listBtn").onclick = ()=> renderList();
  }

  function scoreOf(rec){
    return RUBRIC.reduce((acc,c)=> acc + (rec.levels?.[c.key] || 0), 0);
  }
  function maxScore(){ return RUBRIC.length * 4; }

  function renderList(){
    const list = loadObs();
    view.innerHTML = `
      <div class="card">
        <h2>ğŸ“š Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</h2>
        <div class="notice">
          ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ØµÙ Ø£Ùˆ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³ØŒ Ø«Ù… ÙØªØ­ Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©.
        </div>

        <div class="tools">
          <input id="q" class="search" placeholder="Ø¨Ø­Ø«: Ù…Ø«Ø§Ù„ (Ø®Ø§Ù…Ø³) Ø£Ùˆ (Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø§Ø¯Ø©)..." />
          <button class="btn green" id="newCardBtn">â• Ø¨Ø·Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
          <button class="btn" id="printBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
        </div>

        <div id="listBox" class="list"></div>
        <div class="muted" style="margin-top:10px">Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª: <b id="count"></b></div>
      </div>
    `;

    const box = document.getElementById("listBox");
    const count = document.getElementById("count");

    function draw(filtered){
      if(!filtered.length){
        box.innerHTML = `<div class="notice">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>`;
      } else {
        box.innerHTML = filtered.map(rec=>{
          const when = new Date(rec.updatedAt || rec.createdAt).toLocaleString("ar-SA");
          const sc = scoreOf(rec);
          return `
            <div class="item">
              <div class="itemTop">
                <div>
                  <div class="itemTitle">Ø§Ù„ØµÙ ${esc(rec.grade)} â€” ${esc(rec.lessonTitle)}</div>
                  <div class="itemMeta">
                    Ø§Ù„ØªØ§Ø±ÙŠØ®: ${esc(rec.date || "")} â€” Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${esc(when)}
                    <span class="pill">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ${sc}/${maxScore()}</span>
                  </div>
                </div>
                <div class="itemBtns">
                  <button class="btn primary" data-edit="${esc(rec.id)}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                  <button class="btn" data-view="${esc(rec.id)}">ğŸ‘ï¸ Ø¹Ø±Ø¶</button>
                  <button class="btn danger" data-del="${esc(rec.id)}">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                </div>
              </div>
              <div class="muted" style="margin-top:8px">
                Ø§Ù„Ù…Ù„Ø§Ø­ÙØ¸Ø©: ${esc(rec.observerName || "")}
                ${rec.teacherObserved ? " â€” Ø§Ù„Ù…Ø¹Ù„Ù…Ø© Ø§Ù„Ù…ÙÙ„Ø§Ø­Ø¸Ø©: " + esc(rec.teacherObserved) : ""}
              </div>
            </div>
          `;
        }).join("");
      }
      count.textContent = String(filtered.length);

      // Ø£Ø²Ø±Ø§Ø±
      box.querySelectorAll("[data-edit]").forEach(b=>{
        b.onclick = ()=> renderForm(b.getAttribute("data-edit"));
      });
      box.querySelectorAll("[data-view]").forEach(b=>{
        b.onclick = ()=> renderReadOnly(b.getAttribute("data-view"));
      });
      box.querySelectorAll("[data-del]").forEach(b=>{
        b.onclick = ()=>{
          const id = b.getAttribute("data-del");
          if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŸ")) return;
          const next = loadObs().filter(x=>x.id!==id);
          saveObs(next);
          draw(filterList(document.getElementById("q").value || ""));
        };
      });
    }

    function filterList(q){
      q = (q||"").trim().toLowerCase();
      if(!q) return list;
      return list.filter(r=>{
        const g = ("ØµÙ " + (r.grade||"")).toLowerCase();
        const t = (r.lessonTitle||"").toLowerCase();
        const o = (r.observerName||"").toLowerCase();
        return g.includes(q) || t.includes(q) || o.includes(q);
      });
    }

    document.getElementById("q").oninput = (e)=> draw(filterList(e.target.value));
    document.getElementById("newCardBtn").onclick = ()=> renderForm(null);
    document.getElementById("printBtn").onclick = ()=> window.print();

    draw(list);
  }

  function renderReadOnly(id){
    const list = loadObs();
    const rec = list.find(x=>x.id===id);
    if(!rec){ renderList(); return; }

    const when = new Date(rec.updatedAt || rec.createdAt).toLocaleString("ar-SA");
    const rubricRows = RUBRIC.map(c=>{
      const lvl = rec.levels?.[c.key] || 0;
      const txt = lvl ? c.desc[lvl-1] : "â€”";
      return `
        <div class="crit">
          <div class="critHead">
            <div class="critName">${esc(c.name)}</div>
            <div class="muted">Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <b>${lvl || "â€”"}</b> â€” ${esc(txt)}</div>
          </div>
        </div>
      `;
    }).join("");

    view.innerHTML = `
      <div class="card">
        <h2>ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</h2>
        <div class="notice">
          Ø§Ù„ØµÙ ${esc(rec.grade)} â€” ${esc(rec.lessonTitle)} â€” Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${esc(when)}
          <span class="pill">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ${scoreOf(rec)}/${maxScore()}</span>
        </div>

        <div class="row">
          <div class="col">
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <input value="${esc(rec.date||"")}" disabled />
          </div>
          <div class="col">
            <label>Ø§Ù„Ù…Ù„Ø§Ø­ÙØ¸Ø©</label>
            <input value="${esc(rec.observerName||"")}" disabled />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>Ø§Ù„Ù…Ø¹Ù„Ù…Ø© Ø§Ù„Ù…ÙÙ„Ø§Ø­Ø¸Ø©</label>
            <input value="${esc(rec.teacherObserved||"")}" disabled />
          </div>
          <div class="col">
            <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³</label>
            <input value="${esc(rec.lessonTitle||"")}" disabled />
          </div>
        </div>

        <div class="hr"></div>
        <h2 style="font-size:16px;margin:0 0 6px">Ø³Ù„Ø§Ù„Ù… Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</h2>
        <div class="rubric">${rubricRows}</div>

        <label>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <textarea disabled>${esc(rec.notes||"")}</textarea>

        <div class="tools">
          <button class="btn primary" id="editBtn">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn" id="listBtn">ğŸ“š Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
          <button class="btn" id="printBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
        </div>
      </div>
    `;

    document.getElementById("editBtn").onclick = ()=> renderForm(id);
    document.getElementById("listBtn").onclick = ()=> renderList();
    document.getElementById("printBtn").onclick = ()=> window.print();
  }

  // ===== Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ =====
  document.getElementById("goForm").onclick = ()=> renderForm(null);
  document.getElementById("goList").onclick = ()=> renderList();
  document.getElementById("clearLocal").onclick = ()=>{
    if(confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙ‚Ø·. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ")){
      localStorage.removeItem(LS_OBS);
      localStorage.removeItem(LS_GRADE);
      renderForm(null);
    }
  };

  // ===== ØªØ´ØºÙŠÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ =====
  renderForm(null);
</script>

</body>
</html>
