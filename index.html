<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ù†ØµØ© Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¹Ù„ÙˆÙ… - Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…Ø© Ø¨Ø¯Ø±ÙŠØ© Ù…Ø­Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</title>
  <style>
    :root{
      --bg:#0b1220; --card:#101a33; --text:#eef4ff; --muted:#a7b4d6;
      --accent:#6aa8ff; --danger:#ff6a6a; --border:rgba(255,255,255,.14);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:radial-gradient(1000px 700px at 70% 10%, rgba(106,168,255,.18), transparent 60%),
                 radial-gradient(900px 650px at 15% 90%, rgba(255,106,106,.12), transparent 60%),
                 var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      font-size:20px;
      line-height:1.6;
    }
    .wrap{max-width:1100px; margin:0 auto; padding:18px 14px 30px}
    .top{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border-radius:var(--radius);
      padding:16px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
      position:sticky; top:10px; z-index:20;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{
      width:44px; height:44px; border-radius:14px;
      background:conic-gradient(from 210deg, var(--accent), #8dffb0, #ffd48a, var(--accent));
      box-shadow:0 12px 30px rgba(106,168,255,.22);
    }
    h1{margin:0; font-size:22px}
    .sub{margin:3px 0 0; color:var(--muted); font-size:14px}
    .btns{display:flex; gap:10px; flex-wrap:wrap}
    button{
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      font-size:16px;
    }
    button:hover{background:rgba(255,255,255,.10)}
    button.primary{border-color:rgba(106,168,255,.45); background:rgba(106,168,255,.18)}
    button.danger{border-color:rgba(255,106,106,.55); background:rgba(255,106,106,.14)}

    .grid{display:grid; gap:14px; margin-top:14px}
    @media(min-width:980px){ .grid{grid-template-columns: 1.05fr .95fr} }

    .card{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border-radius:var(--radius);
      padding:16px;
    }
    .card h2{margin:0 0 8px; font-size:20px}
    .muted{color:var(--muted); font-size:14px}

    label{display:block; color:var(--muted); font-size:15px; margin-top:10px}
    input, select, textarea{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      font-size:18px;
      outline:none;
      margin-top:6px;
    }
    textarea{min-height:90px; resize:vertical}

    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; align-items:center}
    .notice{
      border:1px dashed rgba(255,255,255,.25);
      background:rgba(255,255,255,.04);
      padding:12px;
      border-radius:16px;
      color:var(--muted);
      font-size:15px;
    }

    .item{
      border:1px solid var(--border);
      background:rgba(0,0,0,.14);
      border-radius:16px;
      padding:12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .item .t{font-weight:800}
    .item .m{color:var(--muted); font-size:14px}
    .actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    a.linkbtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      text-decoration:none;
      font-size:16px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    a.linkbtn:hover{background:rgba(255,255,255,.10)}
    a.linkbtn.primary{border-color:rgba(106,168,255,.45); background:rgba(106,168,255,.18)}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:13px;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.22);
      color:var(--text);
      display:inline-block;
      direction:ltr;
      user-select:all;
      word-break:break-all;
    }

    /* Rubric */
    .rubric{display:grid; gap:10px; margin-top:10px}
    .crit{
      border:1px solid var(--border);
      background:rgba(0,0,0,.12);
      border-radius:16px;
      padding:12px;
    }
    .crit .head{display:flex; gap:10px; justify-content:space-between; flex-wrap:wrap}
    .crit .name{font-weight:800}
    .scale{display:grid; gap:8px; margin-top:10px}
    @media(min-width:980px){ .scale{grid-template-columns: repeat(4, 1fr)} }
    .lvl{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background:rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
      min-height:64px;
      display:flex; flex-direction:column; gap:6px;
    }
    .lvl b{font-size:15px}
    .lvl span{font-size:13px; color:var(--muted)}
    .lvl.active{border-color: rgba(106,168,255,.65); background:rgba(106,168,255,.15)}
    .hr{height:1px; background:var(--border); margin:12px 0}
    .table{width:100%; border-collapse:collapse; margin-top:10px; font-size:14px}
    .table th,.table td{border:1px solid var(--border); padding:8px; vertical-align:top}
    .table th{background:rgba(255,255,255,.06); text-align:right}
    .tag{font-size:12px; color:var(--muted)}
    @media print{
      body{background:white; color:black}
      .top,.btns{display:none !important}
      .card{box-shadow:none; background:white; border:1px solid #ccc}
      .lvl{background:white}
      .notice{border:1px dashed #999}
      a.linkbtn{display:none !important}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Ù…Ù†ØµØ© Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¹Ù„ÙˆÙ…</h1>
          <div class="sub">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù…Ø© Ø¨Ø¯Ø±ÙŠØ© Ù…Ø­Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</div>
        </div>
      </div>
      <div class="btns">
        <button id="homeBtn" class="primary" type="button">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button id="obsBtn" type="button">ğŸ“ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
        <button id="resetBtn" class="danger" type="button" title="ÙŠÙ…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙ‚Ø·">ğŸ§¹ Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²</button>
      </div>
    </div>

    <div id="app" class="grid"></div>
  </div>

<script>
  // Ø±ÙˆØ§Ø¨Ø· ÙƒØ§Ù†ÙØ§ (ØµÙÙˆÙ)
  const CANVA = {
    4: "https://36primery-school.my.canva.site/dahajdyfjhk",
    5: "https://36primery-school.my.canva.site/dahajeso-mu",
    6: "https://36primery-school.my.canva.site/dahairgwces"
  };

  // Ø¯Ø±ÙˆØ³ Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ø¢Ù† = Ù†ÙØ³ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙ)
  // Ø¥Ø°Ø§ Ø£Ø¹Ø·ÙŠØªÙŠÙ†ÙŠ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø±ÙˆØ§Ø¨Ø· Ù…Ù†ÙØµÙ„Ø© Ù„ÙƒÙ„ Ø¯Ø±Ø³ØŒ Ø£Ø±Ø¨Ø·Ù‡Ø§ Ù‡Ù†Ø§ Ø¨Ø³Ù‡ÙˆÙ„Ø©.
  const LESSONS = {
    4: ["Ø¯Ø±Ø³ 1","Ø¯Ø±Ø³ 2","Ø¯Ø±Ø³ 3","Ø¯Ø±Ø³ 4","Ø¯Ø±Ø³ 5"],
    5: ["Ø¯Ø±Ø³ 1","Ø¯Ø±Ø³ 2","Ø¯Ø±Ø³ 3","Ø¯Ø±Ø³ 4","Ø¯Ø±Ø³ 5"],
    6: ["Ø¯Ø±Ø³ 1","Ø¯Ø±Ø³ 2","Ø¯Ø±Ø³ 3","Ø¯Ø±Ø³ 4","Ø¯Ø±Ø³ 5"]
  };

  const LS_NAME = "science_platform_visitor_name_v1";
  const LS_VIS  = "science_platform_visits_v1";
  const LS_OBS  = "science_platform_observations_v1";

  function esc(s){ return (s??"").toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function nowISO(){ return new Date().toISOString(); }

  function baseUrl(){
    const u = new URL(location.href);
    // Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (GitHub Pages) Ù„ÙƒÙ† Ø§Ø­Ø°Ù Ø§Ù„Ø¨Ø§Ø±Ø§Ù…ÙŠØªØ±Ø§Øª
    u.search = "";
    return u.toString();
  }
  function shareLink(grade, lessonIndex){
    const u = new URL(location.href);
    u.searchParams.set("grade", grade);
    u.searchParams.set("lesson", lessonIndex);
    return u.toString();
  }

  function saveVisit(name, grade, lessonIndex){
    const log = JSON.parse(localStorage.getItem(LS_VIS) || "[]");
    log.unshift({t: nowISO(), name, grade, lessonIndex});
    localStorage.setItem(LS_VIS, JSON.stringify(log.slice(0, 300)));
  }

  function renderVisits(){
    const box = document.getElementById("visitsBox");
    if(!box) return;
    const log = JSON.parse(localStorage.getItem(LS_VIS) || "[]");
    if(!log.length){ box.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²."; return; }
    const rows = log.slice(0, 12).map(v=>{
      const when = new Date(v.t).toLocaleString("ar-SA");
      return `â€¢ ${esc(v.name)} â€” ØµÙ ${esc(v.grade)} â€” Ø¯Ø±Ø³ ${esc(v.lessonIndex)} â€” ${esc(when)}`;
    }).join("<br>");
    box.innerHTML = rows;
  }

  // Ù…Ù‡Ù…: ÙØªØ­ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø¹Ø¨Ø± <a> Ù„ØªÙØ§Ø¯ÙŠ Ø­Ø¸Ø± Ø§Ù„Ù†ÙˆØ§ÙØ°
  function linkButton(href, label, cls=""){
    return `<a class="linkbtn ${cls}" href="${esc(href)}" target="_blank" rel="noopener noreferrer">${label}</a>`;
  }

  function renderHome(){
    const savedName = localStorage.getItem(LS_NAME) || "";
    const app = document.getElementById("app");
    app.innerHTML = `
      <div class="card">
        <h2>Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <div class="notice">
          Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù„Ø§ ØªÙØªØ­ Ø³Ø§Ø¨Ù‚Ù‹Ø§ ÙØ°Ù„Ùƒ Ø¨Ø³Ø¨Ø¨ Ù…Ù†Ø¹ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©.
          Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© ØªÙØªØ­ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙƒÙ€ <b>Ø±ÙˆØ§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±Ø©</b> Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„Ù‡Ø§.
        </div>

        <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø© / Ø§Ù„Ø²Ø§Ø¦Ø±Ø©</label>
        <input id="nameInput" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§" value="${esc(savedName)}"/>

        <label>Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ØµÙ</label>
        <select id="gradeSelect">
          <option value="">-- Ø§Ø®ØªØ§Ø±ÙŠ --</option>
          <option value="4">Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹</option>
          <option value="5">Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</option>
          <option value="6">Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option>
        </select>

        <div class="row">
          <button id="enterBtn" class="primary" type="button">âœ… Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø±ÙˆØ³</button>
          <span class="tag">Ø£Ùˆ Ø§ÙØªØ­ÙŠ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ</span>
        </div>

        <div class="row" id="directLinksRow" style="margin-top:10px"></div>

        <div class="notice" style="margin-top:12px">
          Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØµØ© Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©: <span class="kbd">${esc(baseUrl())}</span>
        </div>
      </div>

      <div class="card">
        <h2>Ø¢Ø®Ø± Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª (Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²)</h2>
        <div id="visitsBox" class="notice">...</div>
      </div>
    `;

    const directRow = document.getElementById("directLinksRow");
    directRow.innerHTML =
      linkButton(CANVA[4], "ğŸ”— ÙØªØ­ ØªÙ‚ÙˆÙŠÙ… Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹", "primary") +
      linkButton(CANVA[5], "ğŸ”— ÙØªØ­ ØªÙ‚ÙˆÙŠÙ… Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³", "primary") +
      linkButton(CANVA[6], "ğŸ”— ÙØªØ­ ØªÙ‚ÙˆÙŠÙ… Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³", "primary");

    document.getElementById("enterBtn").onclick = () => {
      const name = (document.getElementById("nameInput").value || "").trim();
      const grade = document.getElementById("gradeSelect").value;
      if(!name || !grade){
        alert("Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ØµÙ.");
        return;
      }
      localStorage.setItem(LS_NAME, name);
      renderLessons(name, grade);
    };

    renderVisits();
  }

  function renderLessons(name, grade){
    const app = document.getElementById("app");
    const list = LESSONS[grade] || ["Ø¯Ø±Ø³ Ø¹Ø§Ù…"];
    const items = list.map((title, idx)=>{
      const lessonIndex = idx + 1;
      const share = shareLink(grade, lessonIndex);

      // Ø­Ø§Ù„ÙŠØ§Ù‹ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø±Ø³ = Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙ (Ø­ØªÙ‰ ØªØ²ÙˆØ¯ÙŠÙ†ÙŠ Ø¨Ø±ÙˆØ§Ø¨Ø· Ø¯Ø±ÙˆØ³ Ù…Ù†ÙØµÙ„Ø©)
      const canvaUrl = CANVA[grade];

      return `
        <div class="item">
          <div>
            <div class="t">${esc(title)} (Ø§Ù„ØµÙ ${esc(grade)})</div>
            <div class="m">Ø±Ø§Ø¨Ø· Ø®Ø§Øµ Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ (ÙŠÙØªØ­ Ø§Ù„Ø¯Ø±Ø³ Ù…Ø¨Ø§Ø´Ø±Ø©)</div>
            <div class="kbd">${esc(share)}</div>
          </div>
          <div class="actions">
            ${linkButton(canvaUrl, "ÙØªØ­ Ø§Ù„Ø¯Ø±Ø³", "primary")}
            <button type="button" data-copy="${lessonIndex}">Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</button>
          </div>
        </div>
      `;
    }).join("");

    app.innerHTML = `
      <div class="card">
        <h2>Ù…Ø±Ø­Ø¨Ù‹Ø§ ${esc(name)} ğŸ‘‹</h2>
        <div class="notice">
          Ø§Ù„ØµÙ Ø§Ù„Ù…Ø®ØªØ§Ø±: <b>${esc(grade)}</b> â€” Ø§ÙØªØ­ÙŠ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø¨Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Ø±ÙˆØ§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±Ø©).
        </div>
        <div class="row">
          ${linkButton(CANVA[grade], "ğŸ”— ÙØªØ­ ØªÙ‚ÙˆÙŠÙ… Ø§Ù„ØµÙ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„", "primary")}
          <button id="backBtn" type="button">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
        </div>

        ${items}

        <div class="hr"></div>
        <div class="notice">
          âœ³ï¸ Ø¥Ø°Ø§ Ø±ØºØ¨ØªÙ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„ÙƒÙ„ Ø¯Ø±Ø³ Ø±Ø§Ø¨Ø· ÙƒØ§Ù†ÙØ§ Ù…Ø³ØªÙ‚Ù„ (Ø¨Ø¯Ù„ Ø±Ø§Ø¨Ø· ÙˆØ§Ø­Ø¯ Ù„Ù„ØµÙ)ØŒ Ø£Ø±Ø³Ù„ÙŠ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ³Ø£Ø±Ø¨Ø·Ù‡Ø§ Ù‡Ù†Ø§.
        </div>
      </div>

      <div class="card">
        <h2>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</h2>
        <div class="notice">Ø§Ø¶ØºØ·ÙŠ Ø²Ø± <b>ğŸ“ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</b> Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„ØªØ¹Ø¨Ø¦Ø© Ø¨Ø·Ø§Ù‚Ø© ØªÙØ§Ø¹Ù„ÙŠØ© Ø¨Ø³Ù„Ø§Ù„Ù… ØªÙ‚Ø¯ÙŠØ± ÙˆØ­ÙØ¸Ù‡Ø§ ÙˆØ·Ø¨Ø§Ø¹Ø©Ù‡Ø§.</div>
      </div>
    `;

    document.getElementById("backBtn").onclick = () => renderHome();

    app.querySelectorAll("[data-copy]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const lessonIndex = Number(btn.getAttribute("data-copy")) || 0;
        const share = shareLink(grade, lessonIndex);
        try{
          await navigator.clipboard.writeText(share);
          btn.textContent = "âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®";
          setTimeout(()=> btn.textContent="Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©", 900);
        }catch(e){
          alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. Ø§Ù†Ø³Ø®ÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø¸Ø§Ù‡Ø±.");
        }
      });
    });
  }

  // -------- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© (Rubric) --------
  const RUBRIC = [
    { key:"objective", name:"ÙˆØ¶ÙˆØ­ Ø§Ù„Ù‡Ø¯Ù", desc:["ØºÙŠØ± ÙˆØ§Ø¶Ø­", "ÙˆØ§Ø¶Ø­ Ø¬Ø²Ø¦ÙŠÙ‹Ø§", "ÙˆØ§Ø¶Ø­", "ÙˆØ§Ø¶Ø­ ÙˆÙ…ÙØ¹Ù„Ù† Ù„Ù„Ø·Ø§Ù„Ø¨Ø§Øª"] },
    { key:"engage", name:"ØªÙØ§Ø¹Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª", desc:["Ø¶Ø¹ÙŠÙ", "Ù…ØªÙˆØ³Ø·", "Ø¬ÙŠØ¯", "Ø¹Ø§Ù„Ù ÙˆÙ…ØªÙ†ÙˆØ¹"] },
    { key:"strategy", name:"Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ¹Ù„Ù…", desc:["ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨Ø©", "Ù…Ø­Ø¯ÙˆØ¯Ø©", "Ù…Ù†Ø§Ø³Ø¨Ø©", "Ù…Ù†Ø§Ø³Ø¨Ø© + ØªÙ…Ø§ÙŠØ²"] },
    { key:"assessment", name:"ØªÙ‚ÙˆÙŠÙ… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯Ø±Ø³", desc:["Ù„Ø§ ÙŠÙˆØ¬Ø¯", "Ù…Ø­Ø¯ÙˆØ¯", "Ù…Ø³ØªÙ…Ø±", "Ù…Ø³ØªÙ…Ø± + ØªØºØ°ÙŠØ© Ø±Ø§Ø¬Ø¹Ø©"] },
    { key:"classroom", name:"Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ", desc:["ØªØ­ØªØ§Ø¬ Ø¯Ø¹Ù…", "Ù…Ù‚Ø¨ÙˆÙ„Ø©", "Ø¬ÙŠØ¯Ø©", "Ù…ØªÙ…ÙŠØ²Ø©"] },
  ];

  function loadObs(){
    return JSON.parse(localStorage.getItem(LS_OBS) || "[]");
  }
  function saveObs(list){
    localStorage.setItem(LS_OBS, JSON.stringify(list));
  }

  function renderObservation(){
    const savedName = localStorage.getItem(LS_NAME) || "";
    const app = document.getElementById("app");

    const today = new Date();
    const y = today.getFullYear(), m = String(today.getMonth()+1).padStart(2,'0'), d = String(today.getDate()).padStart(2,'0');
    const todayStr = `${y}-${m}-${d}`;

    const rubricHtml = RUBRIC.map((c, idx)=>`
      <div class="crit" data-crit="${esc(c.key)}">
        <div class="head">
          <div class="name">${idx+1}) ${esc(c.name)}</div>
          <div class="muted">Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø³ØªÙˆÙ‰ ÙˆØ§Ø­Ø¯</div>
        </div>
        <div class="scale">
          ${[1,2,3,4].map(lvl=>`
            <div class="lvl" data-lvl="${lvl}">
              <b>Ù…Ø³ØªÙˆÙ‰ ${lvl}</b>
              <span>${esc(c.desc[lvl-1])}</span>
            </div>
          `).join("")}
        </div>
      </div>
    `).join("");

    app.innerHTML = `
      <div class="card">
        <h2>ğŸ“ Ø¨Ø·Ø§Ù‚Ø© Ù…Ù„Ø§Ø­Ø¸Ø© ØªÙØ§Ø¹Ù„ÙŠØ©</h2>
        <div class="notice">
          ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø². ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø©.
        </div>

        <div class="row">
          <button id="printBtn" type="button">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
          <button id="backHomeBtn" class="primary" type="button">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div style="flex:1; min-width:240px">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ø§Ø­ÙØ¸Ø© / Ø§Ù„Ù…Ø¹Ù„Ù…Ø©</label>
            <input id="obsBy" value="Ø¨Ø¯Ø±ÙŠØ© Ù…Ø­Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ" />
          </div>
          <div style="flex:1; min-width:240px">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</label>
            <input id="obsDate" type="date" value="${esc(todayStr)}" />
          </div>
        </div>

        <div class="row">
          <div style="flex:1; min-width:240px">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø© Ø§Ù„Ù…ÙÙ„Ø§Ø­ÙØ¸Ø©</label>
            <input id="teacherName" placeholder="Ù…Ø«Ø§Ù„: ..." />
          </div>
          <div style="flex:1; min-width:240px">
            <label>Ø§Ù„ØµÙ/Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
            <input id="className" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø§Ø¯Ø³/Ø£" />
          </div>
        </div>

        <div class="row">
          <div style="flex:1; min-width:240px">
            <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³</label>
            <input id="lessonTitle" placeholder="Ù…Ø«Ø§Ù„: ..." />
          </div>
          <div style="flex:1; min-width:240px">
            <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="studentName" value="${esc(savedName)}" />
          </div>
        </div>

        <div class="rubric" id="rubricBox">${rubricHtml}</div>

        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù†ÙˆØ¹ÙŠØ©</label>
        <textarea id="notes" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea>

        <div class="row">
          <button id="saveObsBtn" class="primary" type="button">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</button>
          <button id="clearObsBtn" type="button">ğŸ§½ Ù…Ø³Ø­ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</button>
        </div>

      </div>

      <div class="card">
        <h2>Ø³Ø¬Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª (Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²)</h2>
        <div id="obsList" class="notice">...</div>
      </div>
    `;

    // ØªÙØ¹ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
    const selections = {}; // key => level
    document.querySelectorAll(".crit").forEach(crit=>{
      const key = crit.getAttribute("data-crit");
      crit.querySelectorAll(".lvl").forEach(box=>{
        box.addEventListener("click", ()=>{
          const lvl = Number(box.getAttribute("data-lvl"));
          selections[key] = lvl;
          // reset visuals
          crit.querySelectorAll(".lvl").forEach(x=>x.classList.remove("active"));
          box.classList.add("active");
        });
      });
    });

    document.getElementById("clearObsBtn").onclick = ()=>{
      Object.keys(selections).forEach(k=>delete selections[k]);
      document.querySelectorAll(".lvl").forEach(x=>x.classList.remove("active"));
      document.getElementById("notes").value = "";
    };

    document.getElementById("saveObsBtn").onclick = ()=>{
      const record = {
        id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()),
        t: nowISO(),
        obsBy: (document.getElementById("obsBy").value||"").trim(),
        date: (document.getElementById("obsDate").value||"").trim(),
        teacherName: (document.getElementById("teacherName").value||"").trim(),
        className: (document.getElementById("className").value||"").trim(),
        lessonTitle: (document.getElementById("lessonTitle").value||"").trim(),
        studentName: (document.getElementById("studentName").value||"").trim(),
        levels: {...selections},
        notes: (document.getElementById("notes").value||"").trim(),
      };

      // ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ·
      const picked = Object.keys(record.levels).length;
      if(!record.teacherName || !record.className || !record.lessonTitle){
        alert("ÙØ¶Ù„Ø§Ù‹: Ø§ÙƒÙ…Ù„ÙŠ (Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©/Ø§Ù„ØµÙ/Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³).");
        return;
      }
      if(picked < 3){
        alert("ÙØ¶Ù„Ø§Ù‹: Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø³ØªÙˆÙŠØ§Øª Ø³Ù„Ø§Ù„Ù… Ø§Ù„ØªÙ‚Ø¯ÙŠØ± (Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 3 Ù…Ø¹Ø§ÙŠÙŠØ±).");
        return;
      }

      const list = loadObs();
      list.unshift(record);
      saveObs(list.slice(0, 200));
      alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© âœ…");
      renderObsList();
    };

    document.getElementById("printBtn").onclick = ()=> window.print();
    document.getElementById("backHomeBtn").onclick = ()=> renderHome();

    function renderObsList(){
      const box = document.getElementById("obsList");
      const list = loadObs();
      if(!list.length){
        box.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯.";
        return;
      }

      const rows = list.slice(0, 12).map(r=>{
        const when = new Date(r.t).toLocaleString("ar-SA");
        const score = RUBRIC.reduce((acc,c)=> acc + (r.levels?.[c.key]||0), 0);
        const max = RUBRIC.length * 4;
        return `
          <div style="margin-bottom:10px">
            <b>${esc(r.teacherName)}</b> â€” ${esc(r.className)} â€” ${esc(r.lessonTitle)}<br>
            <span class="tag">${esc(r.date)} â€” ${esc(when)} â€” Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${score}/${max}</span><br>
            <button type="button" data-del="${esc(r.id)}" style="margin-top:6px">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        `;
      }).join("<div class='hr'></div>");

      box.innerHTML = rows;

      box.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-del");
          const list = loadObs().filter(x=>x.id !== id);
          saveObs(list);
          renderObsList();
        });
      });
    }

    renderObsList();
  }

  // Ø¯Ø¹Ù… Ø±Ø§Ø¨Ø· Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¯Ø±Ø³: ?grade=6&lesson=2
  function handleDeepLink(){
    const p = new URLSearchParams(location.search);
    const grade = p.get("grade");
    const lesson = Number(p.get("lesson") || "0");

    if(!grade) return false;

    const name = (localStorage.getItem(LS_NAME) || "").trim();
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ù‚Ø¨Ù„: Ø§ÙØªØ­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    if(!name){
      renderHome();
      setTimeout(()=> alert("Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§ÙØªØ­ÙŠ Ø§Ù„Ø¯Ø±Ø³."), 50);
      return true;
    }

    saveVisit(name, grade, lesson || 0);
    // Ù†Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ø¯Ø±ÙˆØ³ (ÙˆØ§Ù„ÙØªØ­ ÙŠÙƒÙˆÙ† Ø¹Ø¨Ø± Ø²Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¨Ø§Ø´Ø±)
    renderLessons(name, grade);
    return true;
  }

  // Ø£Ø²Ø±Ø§Ø± Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
  document.getElementById("homeBtn").onclick = ()=> renderHome();
  document.getElementById("obsBtn").onclick  = ()=> renderObservation();
  document.getElementById("resetBtn").onclick = ()=>{
    if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙ‚Ø·ØŸ")){
      localStorage.removeItem(LS_NAME);
      localStorage.removeItem(LS_VIS);
      localStorage.removeItem(LS_OBS);
      renderHome();
    }
  };

  // ØªØ´ØºÙŠÙ„
  if(!handleDeepLink()) renderHome();
</script>

</body>
</html>
